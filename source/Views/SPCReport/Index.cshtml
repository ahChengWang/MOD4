@model List<MOD4.Web.ViewModel.SPCDataViewModel>

@{
    ViewBag.Title = "SPC chart";
}

<style>
    .card-title {
        font-size: 30px;
        font-weight: 900;
    }

    table {
        box-shadow: 2px 2px 2px #999;
    }

    .card {
        box-shadow: 2px 2px 2px #999;
        background-color: #c3cadb;
    }

    .my-control {
        display: initial;
        width: 80%;
        height: calc(2.25rem + 2px);
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #495057;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        box-shadow: inset 0 0 0 transparent;
        transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    }
</style>

<head>
    <link rel="stylesheet" href="~/css/buttonStyleCRUD.css">
</head>

<div class="content-wrapper">
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">SPC Trend Chart</h3>
                        </div>
                        <div id="srcDiv1" class="card-body">
                            <div class="form-group d-flex align-content-center flex-wrap">
                                <div class="col-lg-1">
                                    <label class="col-form-label">查詢起日：</label>
                                </div>
                                <div class="col-lg-3">
                                    <input id="startDTE" class="my-control" type="datetime-local" name="name" value="" />
                                </div>
                                <div class="col-lg-1">
                                    <label class="col-form-label">查詢訖日：</label>
                                </div>
                                <div class="col-lg-3">
                                    <input id="endDTE" class="my-control" type="datetime-local" name="name" value="" />
                                </div>
                                <div class="col-lg-1">
                                    <label class="col-form-label">EQP：</label>
                                </div>
                                <div class="col-lg-3">
                                    <select id="selEQ" class="custom-select" style="width:60%" asp-items="@(SelectList)ViewBag.StatusList">
                                        <option value="0"></option>
                                    </select>
                                </div>
                            </div>
                            <div id="srcDiv" class="form-group d-flex align-content-center flex-wrap">
                                <div class="col-lg-1">
                                    <label class="col-form-label">Prod ID：</label>
                                </div>
                                <div class="col-lg-3">
                                    <select id="selProd" class="custom-select" style="width:80%">
                                        @{
                                            <option value="0"></option>
                                            foreach (var lcmProd in ViewBag.ProdOptions)
                                            {
                                                <optgroup label="@lcmProd.Item1">
                                                    @foreach (var item in lcmProd.Item2)
                                                    {
                                                        <option value="@item.Item1">@item.Item2</option>
                                                    }
                                                </optgroup>
                                            }
                                        }
                                    </select>
                                </div>
                                <div class="col-lg-1">
                                    <label class="col-form-label">測項：</label>
                                </div>
                                <div class="col-lg-3">
                                    <select id="selStatus" class="custom-select" style="width:80%" asp-items="@(SelectList)ViewBag.TestItemOptions">
                                        <option value="0"></option>
                                    </select>
                                </div>
                                <div class="col-lg-1">
                                    <input class="btn btn-info" type="button" name="btn29" value="查詢" onclick="btnClickSearch()" />
                                </div>
                            </div>
                            <hr />
                            @*<div id="bar-chart" style="min-height:300px;min-width:300px"></div>*@
                            <div id="lineChart" style="margin-bottom:5px"></div>

                            <table id="sample" class="table table-bordered table-hover">
                            </table>

                            @*@{
                                    if (@Model != null)
                                    {
                                        <table id="sample" class="table table-bordered table-hover">
                                            <thead>
                                                <tr>
                                                    <th class="myth2">@Html.DisplayNameFor(model => model.First().MeasureDate)</th>
                                                    <th class="myth2">@Html.DisplayNameFor(model => model.First().MeasureTime)</th>
                                                    <th class="myth2">@Html.DisplayNameFor(model => model.First().SHTId)</th>
                                                    <th class="myth2">@Html.DisplayNameFor(model => model.First().ProductId)</th>
                                                    <th class="myth2">@Html.DisplayNameFor(model => model.First().DataGroup)</th>
                                                    <th class="myth2">@Html.DisplayNameFor(model => model.First().DTX)</th>
                                                    <th class="myth2">@Html.DisplayNameFor(model => model.First().DTRM)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @{
                                                    foreach (var data in Model)
                                                    {
                                                        <tr>
                                                            <td>@data.MeasureDate</td>
                                                            <td>@data.MeasureTime</td>
                                                            <td>@data.SHTId</td>
                                                            <td>@data.ProductId</td>
                                                            <td>@data.DataGroup</td>
                                                            <td>@data.DTX</td>
                                                            <td>@data.DTRM</td>
                                                        </tr>
                                                    }
                                                }
                                            </tbody>
                                        </table>
                                    }
                                }*@
                        </div>
                        <!-- /.card-body -->
                    </div>
                </div>
                <!-- /.col -->
            </div>
            <!-- /.row -->
        </div>
        <!-- /.container-fluid -->
    </section>
    <!-- /.content -->
</div>

@section scripts{
    <!-- CHARTS -->
    <script src="~/lib/echarts/echarts.js"></script>
    <script type="text/javascript">

        let myFuc = {
            SearchChart() {
                $.blockUI({
                    message: '<img src="./img/Pac_Man.gif" />',
                    css: {
                        borderWidth: '0px',
                        backgroundColor: 'transparent'
                    }
                });

                $.ajax({
                    url: "./SPCReport/Search",
                    type: "GET",
                    success: function (result) {
                        $.unblockUI();
                        if (isJsonString(result)) {
                            var _res = JSON.parse(result);
                            if (result == '""') {
                                alert('查無資料');
                            }
                            if ('isException' in _res) {
                                alert(_res.msg);
                                return false;
                            }
                        }
                        else {
                            $("#sample_wrapper").remove();

                            var _tableHtml = '';
                            $.each(result, function (index, value) {
                                /*console.log(value);*/
                                _tableHtml += '<tr>';
                                _tableHtml += '<td>' + value.measureDate + '</td>';
                                _tableHtml += '<td>' + value.measureTime + '</td>';
                                _tableHtml += '<td>' + value.shtId + '</td>';
                                _tableHtml += '<td>' + value.productId + '</td>';
                                _tableHtml += '<td>' + value.dataGroup + '</td>';
                                _tableHtml += '<td>' + value.dtx + '</td>';
                                _tableHtml += '<td>' + value.dtrm + '</td>';
                                _tableHtml += '</tr>';
                            });
                            $("#sample").append('<thead><tr><th>Measure Date</th><th>Measure Time</th><th>SHT ID</th><th>PROD ID</th><th>Data Group</th><th>DTX</th><th>DTRM</th></tr></thead>'
                                + '<tbody' + _tableHtml + '</tbody>');


                            //$("#bar-chart").after(result);
                            $('#sample').DataTable({
                                "paging": true
                                , "responsive": true
                                , "lengthChange": true
                                , "autoWidth": false
                                , "order": [[1, "asc"]]
                                , "buttons": ["excel", "colvis"]
                            }).buttons().container().appendTo('#sample_wrapper .col-md-6:eq(0)');

                            myFuc.SetChart(result);
                        }
                    }
                });
            },
            SetChart(data) {
                $("#lineChart").css("min-height", "400px");
                /*$("#lineChart").css("min-width", "100%");*/
                $("#lineChart").css("background-color", "#7a8591");
                var chartDom = document.getElementById('lineChart');
                var echar = echarts.init(chartDom);

                var _catgory = ['DTX', 'DTRM', 'Target'];
                var _xAxisTime = [];
                var _dtx = [];
                var _dtrm = [];
                var _title = '';

                $.each(data, function (index, value) {
                    _xAxisTime.push(value.measureTime);
                    _dtx.push(value.dtx);
                    _dtrm.push(value.dtrm);
                    _title = value.dataGroup;
                });

                var option = {
                    title: {
                        text: _title,
                        textStyle: {
                            color: "black",
                            fontWeight: 600,
                            fontSize: 25,
                            textAlign: 'center'
                        }
                    },
                    tooltip: {},
                    legend: {
                        right: '0%',
                        icon: 'circle',
                        data: _catgory,
                        textStyle: { color: "black" }
                    },
                    xAxis: {
                        data: _xAxisTime,
                        axisLabel: { color: "black" }
                    },
                    yAxis: {
                        name: "",
                        nameTextStyle: {
                            color: "black"
                        },
                        axisLabel: {
                            color: "black"
                        }
                    },
                    series: [
                        {
                            name: 'DTX',
                            type: 'line',
                            data: _dtx
                        },
                        {
                            name: 'DTRM',
                            type: 'line',
                            data: _dtrm,
                            itemStyle: {
                                normal: {
                                    color: '#c90e27',
                                    lineStyle: {
                                        width: 2,
                                        type: 'dotted', //'dotted'虚线 'solid'实线
                                        color: '#c90e27'
                                    }
                                }
                            }
                        },
                        {
                            name: 'Target',
                            type: 'line',
                            data: [0, 0, 0, 0, 0],
                            itemStyle: {
                                normal: {
                                    color: 'black'
                                }
                            }
                        }
                    ]
                };

                echar.setOption(option);

                echar.on('click', function (params) {
                    let _test = params;
                })


                /*var barChartCanvas = $('#lineChart').get(0).getContext('2d');*/
                //var barChartData = $.extend(true, {}, areaChartData)

                //var barChartOptions = {
                //    responsive: true,
                //    maintainAspectRatio: false,
                //    datasetFill: false
                //}

                //new Chart(barChartCanvas, {
                //    type: 'bar',
                //    data: areaChartData,
                //    options: barChartOptions,
                //    outerWidth: 500
                //})

                window.addEventListener('resize', function () {
                    echar.resize();
                });
            }
        }

        function btnClickSearch() {
            myFuc.SearchChart();
        }

    </script>
}