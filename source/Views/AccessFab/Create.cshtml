@model MOD4.Web.ViewModel.AccessFabCreateViewModel

@{
    ViewBag.Title = "開立申請單";
}

<style>

    .card {
        box-shadow: 1px 2px 2px 2px #999;
        margin-top: 5px;
    }

    .card-header, .card-body, .card-footer {
        background-color: #c3cadb;
    }

    .card-title {
        font-family: "Microsoft JhengHei";
        font-weight: 900;
        font-style: italic;
        font-size: 30px;
    }
</style>

<div class="content-wrapper">
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">新 增 申 請 單</h3>
                        </div>
                        <!-- /.card-header -->
                        <!-- form start -->
                        <form id="applyForm">
                            <div class="card-body">
                                <div class="form-group" style="display:flex">
                                    <div class="col-2">
                                        <label class="col-form-label" asp-for="FabInTypeId"></label>
                                        <span asp-validation-for="FabInTypeId" style="font-size:10px;font-weight:700" class="text-danger"></span>
                                    </div>
                                    <div class="col-3">
                                        <select class="form-control" asp-for="FabInTypeId" asp-items="@(SelectList)ViewBag.FabInTypeList"></select>
                                    </div>
                                    <div class="col-2">
                                        <label class="col-form-label" asp-for="FabInOtherType"></label>
                                        <span id="spanOtherInput" style="font-size:10px;font-weight:700" class="text-danger"></span>
                                    </div>
                                    <div class="col-3">
                                        <input class="form-control" type="text" asp-for="FabInOtherType" />
                                    </div>
                                </div>
                                <div class="form-group" style="display:flex">
                                    <div class="col-2">
                                        <label class="col-form-label" asp-for="FabInCategoryId"></label>
                                        <span asp-validation-for="FabInCategoryId" style="font-size:10px;font-weight:700" class="text-danger"></span>
                                    </div>
                                    <div class="col-3">
                                        <select class="form-control" asp-for="FabInCategoryId" asp-items="@(SelectList)ViewBag.FabInCategoryList"></select>
                                    </div>
                                </div>
                                <div class="form-group" style="display:flex">
                                    <div class="col-2">
                                        <label class="col-form-label" asp-for="Applicant"></label>
                                        <span style="font-size:10px;font-weight:700" class="text-danger">*</span>
                                        <span asp-validation-for="Applicant" style="font-size:10px;font-weight:700" class="text-danger"></span>
                                    </div>
                                    <div class="col-3">
                                        <input type="text" class="form-control" readonly asp-for="Applicant" value="@ViewBag.AccountName" />
                                    </div>
                                    <div class="col-2">
                                        <label class="col-form-label" asp-for="ApplicantMVPN"></label>
                                        <span style="font-size:10px;font-weight:700" class="text-danger">*</span>
                                        <span asp-validation-for="ApplicantMVPN" style="font-size:10px;font-weight:700" class="text-danger"></span>
                                    </div>
                                    <div class="col-3">
                                        <input type="text" class="form-control" asp-for="ApplicantMVPN" />
                                    </div>
                                </div>
                                <div class="form-group" style="display:flex">
                                    <div class="col-2">
                                        <label class="col-form-label" asp-for="JobId"></label>
                                        <span style="font-size:10px;font-weight:700" class="text-danger">*</span>
                                        <span asp-validation-for="JobId" style="font-size:10px;font-weight:700" class="text-danger"></span>
                                    </div>
                                    <div class="col-3">
                                        <input class="form-control" type="text" asp-for="JobId" />
                                    </div>
                                    <div class="col-2">
                                        <label class="col-form-label" asp-for="AccompanyingPerson"></label>
                                        <span style="font-size:10px;font-weight:700" class="text-danger">*</span>
                                        <span asp-validation-for="AccompanyingPerson" style="font-size:10px;font-weight:700" class="text-danger"></span>
                                    </div>
                                    <div class="col-3">
                                        <input class="form-control" type="text" asp-for="AccompanyingPerson" />
                                    </div>
                                </div>
                                <div class="form-group" style="display: flex;">
                                    <div class="col-2">
                                        <label class="col-form-label" asp-for="Content"></label>
                                        <span style="font-size:10px;font-weight:700" class="text-danger">*</span>
                                        <span asp-validation-for="Content" style="font-size:10px;font-weight:700" class="text-danger"></span>
                                    </div>
                                    <div class="col-8">
                                        <textarea class="form-control" rows="3" asp-for="Content"></textarea>
                                    </div>
                                </div>
                                <div class="form-group" style="display: flex;">
                                    <div class="col-2">
                                        <label class="col-form-label" asp-for="Route"></label>
                                        <span style="font-size:10px;font-weight:700" class="text-danger">*</span>
                                        <span asp-validation-for="Route" style="font-size:10px;font-weight:700" class="text-danger"></span>
                                    </div>
                                    <div class="col-8">
                                        <textarea class="form-control" rows="3" asp-for="Route"></textarea>
                                    </div>
                                </div>
                                <div class="form-group" style="display:flex">
                                    <div class="col-2">
                                        <label class="col-form-label" asp-for="FabInDate"></label>
                                        <span style="font-size:10px;font-weight:700" class="text-danger">*</span>
                                        <span asp-validation-for="FabInDate" style="font-size:10px;font-weight:700" class="text-danger"></span>
                                    </div>
                                    <div class="col-3">
                                        <input type="datetime-local" class="form-control" asp-for="FabInDate">
                                    </div>
                                    <div class="col-2">
                                        <label class="col-form-label" asp-for="FabOutDate"></label>
                                        <span style="font-size:10px;font-weight:700" class="text-danger">*</span>
                                        <span asp-validation-for="FabOutDate" style="font-size:10px;font-weight:700" class="text-danger"></span>
                                    </div>
                                    <div class="col-3">
                                        <input type="datetime-local" class="form-control" asp-for="FabOutDate">
                                    </div>
                                </div>

                                @*<div class="col-md-3 mb-3">
                    <label for="validationCustom">Zip</label>
                    <input type="text" class="form-control" id="validationCustom" required>
                    <div class="invalid-feedback">
                            Please provide a valid zip.
                        </div>
                </div>*@

                                <!--<div class="form-group" style="display:flex">
                <div class="col-2">
                    <label class="col-form-label" asp-for="UploadFile"></label>
                    <span asp-validation-for="UploadFile" style="font-size:10px;font-weight:700" class="text-danger"></span>
                    <div>-->
                                @*<span class="unit">(允許 xls,xlsx,doc,docx,txt,jpg,png,jpeg)</span>*@
                                @*<br />*@
                                <!--<span class="unit">單檔最大2MB</span>
                    </div>
                </div>
                <div class="col-3 custom-file">
                    <input type="file" class="custom-file-input" asp-for="UploadFile" onchange="verifyFile(this)">
                    <label class="custom-file-label">Choose file</label>
                </div>
            </div>-->

                                <hr style="border-width: 3px; border-color: gray" />
                                <h4 style="font-style:italic; font-weight: 600">入廠人員</h4>
                                <div id="guestInfoDiv">
                                    <div id="guestInfo_0" class="form-group" style="display:flex">
                                        <div class="col-1">
                                            <label class="col-form-label" asp-for="Details[0].CompanyName"></label>
                                            <span style="font-size:10px;font-weight:700" class="text-danger">*</span>
                                            <span asp-validation-for="Details[0].CompanyName" style="font-size:10px;font-weight:700" class="text-danger"></span>
                                        </div>
                                        <div class="col-2">
                                            <input type="text" class="form-control" asp-for="Details[0].CompanyName">
                                        </div>
                                        <div class="col-1">
                                            <label class="col-form-label" asp-for="Details[0].Name"></label>
                                            <span style="font-size:10px;font-weight:700" class="text-danger">*</span>
                                            <span asp-validation-for="Details[0].Name" style="font-size:10px;font-weight:700" class="text-danger"></span>
                                        </div>
                                        <div class="col-2">
                                            <input type="text" class="form-control" asp-for="Details[0].Name">
                                        </div>
                                        <div class="col-2">
                                            <label class="col-form-label" asp-for="Details[0].GuestPhone"></label>
                                            <span style="font-size:10px;font-weight:700" class="text-danger">*</span>
                                            <span asp-validation-for="Details[0].GuestPhone" style="font-size:10px;font-weight:700" class="text-danger"></span>
                                        </div>
                                        <div class="col-2">
                                            <input type="text" class="form-control" asp-for="Details[0].GuestPhone">
                                        </div>
                                    </div>
                                </div>
                                <div id="addDiv">
                                    <input id="btnAddGuest" class="btn-light" style="background-color: transparent;font-weight:900;color:black" name="name" type="button" value="+新增人員" />
                                </div>
                            </div>
                            <!-- /.card-body -->
                            <div class="card-footer">
                                <input id="btnCreate" type="submit" class="btn btn-primary" value="建立" />
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

@section scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            $("#FabInOtherType").attr('disabled', true);
        });

        $("#btnAddGuest").click(function () {
            let guestLength = $("#guestInfoDiv").children().length;
            let _latestSn = parseInt(($("#guestInfoDiv").children()[guestLength - 1]).id.split('_')[1]) + 1;

            $('<div id="guestInfo_' + _latestSn + '" class="form-group" style="display:flex">' +
                '<div class="col-1"><label class="col-form-label">單位</label><span style="font-size:10px;font-weight:700" class="text-danger">*</span>' +
                '<span data-valmsg-for="Details[' + _latestSn + '].CompanyName" data-valmsg-replace="true" style="font-size:10px;font-weight:700" class="text-danger field-validation-valid"></span></div>' +
                '<div class="col-2"><input type="text" class="form-control" name="Details[' + _latestSn + '].CompanyName" data-val="true" required /></div>' +
                '<div class="col-1"><label class="col-form-label">姓名</label><span style="font-size:10px;font-weight:700" class="text-danger">*</span>' +
                '<span data-valmsg-for="Details[' + _latestSn + '].Name" data-valmsg-replace="true" style="font-size:10px;font-weight:700" class="text-danger field-validation-valid"></span></div>' +
                '<div class="col-2"><input type="text" class="form-control" name="Details[' + _latestSn + '].Name" data-val="true" required /></div>' +
                '<div class="col-2"><label class="col-form-label">聯絡電話</label><span style="font-size:10px;font-weight:700" class="text-danger">*</span>' +
                '<span data-valmsg-for="Details[' + _latestSn + '].GuestPhone" data-valmsg-replace="true" style="font-size:10px;font-weight:700" class="text-danger field-validation-valid"></span></div>' +
                '<div class="col-2"><input type="text" class="form-control" name="Details[' + _latestSn + '].GuestPhone" data-val="true" required /></div>' +
                '<div class="col-2"><input type="button" class="btn btn-sm btn-outline-secondary" value="刪除" onclick="btnDelGuestInfo(this)"/></div></div>').insertAfter($("#guestInfoDiv").children().last());
        });

        function btnDelGuestInfo(e) {
            e.parentElement.parentElement.remove();
        }

        //window.addEventListener('load', function () {
        //    // Fetch all the forms we want to apply custom Bootstrap validation styles to
        //    // Loop over them and prevent submission
        //    Array.prototype.filter.call($("#applyForm"), function (form) {
        //        form.addEventListener('submit', function (event) {
        //            let _tet = form.checkValidity();
        //            if (form.checkValidity() === false) {
        //                event.preventDefault();
        //                event.stopPropagation();
        //            }
        //            form.classList.add('was-validated');
        //        }, false);
        //    });
        //}, false);


        $("#btnCreate").click(function (e) {

            if ($("#applyForm").valid() && checkOtherInput()) {

                let _guestList = $('#guestInfoDiv').children();
                _guestList.each(function (e, info) {
                    $("#" + info.id).find("input").each(function (de, input) {
                        let _nameArray = input.name.split(".");
                        input.name = "Details[" + e + "]." + _nameArray[1];
                    });
                });

                let _formModel = $("#applyForm").serialize();

                e.preventDefault();
                $.blockUI({
                    message: '請稍等...',
                    css: {
                        border: 'none',
                        padding: '5px',
                        backgroundColor: '#000',
                        '-webkit-border-radius': '10px',
                        '-moz-border-radius': '10px',
                        opacity: '.5',
                        color: '#fff',
                        fontSize: '25px',
                        fontFamily: '微軟正黑體',
                        fontWeight: 300,
                    }
                });
                $.ajax({
                    url: "./Create",
                    type: "POST",
                    dataType: "json",
                    data: _formModel,
                    success: function (res) {
                        $.unblockUI();
                        if (res.isSuccess) {
                            alert('申請成功');
                            location.href = "@Url.ActionLink("Index", "AccessFab")";
                        }
                        else {
                            alert(res.msg);
                            return false;
                        }
                    }
                });
            }
            checkOtherInput();
        });

        function checkOtherInput(e) {
            if ($("#FabInTypeId").find(":selected").val() == 4 && $("#FabInOtherType").val() == "") {
                $("#spanOtherInput").text("*必填");
                return false;
            }
            else
                return true;
        }

        $("#FabInTypeId").change(function (e) {
            let _selVal = $("#FabInTypeId").find(":selected").val();
            if (_selVal == 4) {
                $("#FabInOtherType").removeAttr('disabled');
                $("#FabInOtherType").attr('required', true);
            }
            else {
                $("#FabInOtherType").attr('disabled', true);
                $("#FabInOtherType").removeAttr('required');
                $("#spanOtherInput").text("");
            }
        });

    </script>
}