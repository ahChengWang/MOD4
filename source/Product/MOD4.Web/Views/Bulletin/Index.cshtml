@using System.Linq;
@{
    ViewBag.Title = "公告";
}

<head>
    <link rel="stylesheet" href="~/lib/bootstrap-vue/bootstrap-vue.css" />
    <link rel="stylesheet" href="~/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css" />
</head>

<style>
    table {
        width: 800px;
        border-collapse: collapse;
        overflow: hidden;
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }

    th {
        padding: 10px;
        color: #fff;
        text-align: center;
        background-color: #55608f;
    }

    td {
        padding: 10px;
        text-align: center;
        background-color: rgba(255,255,255,0.2);
    }

    /*.badge {
        position: absolute;*/
    /*top: -0.75em;
        right: -0.75em;
        width: 1.5em;
        height: 1.5em;*/
    /*display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        background-color: red;
        color: white;
    }*/

    .star {
        position: absolute;
        /*margin-left: .9em;
        margin-right: .9em;
        margin-bottom: 1.2em;*/
        border-right: .3em solid transparent;
        border-bottom: .7em solid #FC0;
        border-left: .3em solid transparent;
        /* Controlls the size of the stars. */
        opacity: 0.7;
        font-size: 8px;
    }

        .star:before, .star:after {
            content: '';
            display: block;
            width: 0;
            height: 0;
            position: absolute;
            top: .6em;
            left: -1em;
            border-right: 1em solid transparent;
            border-bottom: .7em solid #FC0;
            border-left: 1em solid transparent;
            transform: rotate(-35deg);
        }

        .star:after {
            transform: rotate(35deg);
        }

    td > div {
        position: relative;
        border-color: transparent;
    }

    .newSwing {
        position: absolute;
        /*top: -0.75em;
        right: -0.75em;
        width: 1.5em;
        height: 1.5em;*/
        background-color: transparent;
        color: #ff1919;
        font-size: 20px;
        font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
        font-weight: 800;
        font-style: italic;
        top: -16px;
        left: 0px;
        animation: swing 1.5s ease-in-out infinite alternate;
    }

    @@keyframes swing {
        0% {
            /*text-shadow: 0 0 20px #ffabab, 0 0 100px #ffabab, 0 0 20px #ffabab;*/
            color: #ffabab;
            transform: rotate(-50grad);
        }

        50% {
            /*text-shadow: 0 0 50px #ff6363, 0 0 150px #ff6363, 0 0 50px #ff6363;*/
            color: #ff6363;
            transform: rotate(30grad);
        }

        100% {
            /*text-shadow: 0 0 20px #ff1919, 0 0 100px #ff1919, 0 0 20px #ff1919;*/
            color: #ff1919;
            transform: rotate(-50grad);
        }
    }

    .newShining {
        position: absolute;
        background-color: transparent;
        transform: rotate(-20grad);
        color: #ff1919;
        font-size: 20px;
        font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
        font-weight: 800;
        font-style: italic;
        top: -16px;
        left: 0px;
        -webkit-mask-image: linear-gradient(-75deg, rgba(255, 17, 0,.3) 0%, rgba(255, 17, 0,.8) 30%, rgba(255, 17, 0) 100%);
        -webkit-mask-size: 200%;
        animation: shine 2s linear infinite;
    }

    @@keyframes shine {
        from {
            -webkit-mask-position: 150%;
        }

        to {
            -webkit-mask-position: -50%;
        }
    }

    .row > [class^="col-"] {
        border: 1px solid rgba(86,61,124,0.2);
        padding: 1rem;
    }

    .row > [name="title"] {
        font-size: 14px;
        background-color: rgba(86,61,124,0.15);
    }


    div[name='remark'] {
        color: #ff1919;
        font-size: 15px;
        font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
        font-weight: 700;
        animation: remark 1.5s ease-in-out infinite alternate;
    }

    @@keyframes remark {
        0% {
            text-shadow: 0 0 20px #ffabab, 0 0 100px #ffabab, 0 0 20px #ffabab;
            color: #ffabab;
        }

        50% {
            text-shadow: 0 0 50px #ff6363, 0 0 150px #ff6363, 0 0 50px #ff6363;
            color: #ff6363;
        }

        100% {
            text-shadow: 0 0 20px #ff1919, 0 0 100px #ff1919, 0 0 20px #ff1919;
            color: #ff1919;
        }
    }

    #createModal .modal-header {
        background-color: #616a8f;
    }

    #createModal .modal-body, #createModal .modal-footer {
        background-color: #c3cadb;
    }

    .dropdown-menu {
        max-height: 300px;
        overflow: scroll;
        overflow-x: hidden;
    }

    .unit {
        font-size: 8px;
        color: darkred;
    }

    div[name='tgSection'] {
        width: 200px;
        padding: 1px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        /*display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;*/
    }

        div[name='tgSection']:hover {
            overflow: visible;
            white-space: normal;
            text-overflow: initial;
            /*display: block;*/
        }
</style>

<div class="content-wrapper">
    <section class="content">
        <div class="container-fluid">
            <div id="app" class="card">
                <div class="card-header">
                    <h3 class="card-title">最新公告</h3>
                </div>
                <!-- /.card-header -->
                <!-- form start -->
                <div class="card-body">
                    <fieldset id="searchArea">
                        <legend id="legend">查詢區塊</legend>
                        <div class="d-flex align-content-center flex-wrap">
                            <div class="col-lg-1">
                                <label class="col-form-label">公告日</label>
                                <span style="font-size:8px;font-weight:700" class="text-danger">*</span>
                            </div>
                            <div class="col-lg-3">
                                <input class="form-control" name="datepicker" />
                            </div>
                            <div class="col-lg-1">
                                <label class="col-form-label">狀態</label>
                            </div>
                            <div class="col-lg-1">
                                <select id="dropStatus" class="form-control" v-model="readStatus">
                                    <option v-for="status in statusOptions" :value="status.value">{{status.text}}</option>
                                </select>
                            </div>
                            <div class="col-lg-2">
                                <input type="button" name="btn29" value="查詢" @@click="onSearchClk" />
                            </div>
                        </div>
                        <br />
                    </fieldset>
                    <div v-if="permision.accountPermission & 32">
                        <input id="btnCreate" type="button" style="margin-bottom: 8px;" class="btn animated infinite flash" name="btn30" value="+建立新公告" data-toggle="modal" data-target="#createModal" />
                    </div>
                    <div>
                        <table id="table1" class="table table-bordered table-hover" v-if="rawData.length != 0">
                            <thead>
                                <tr>
                                    <th>公告日(Date)</th>
                                    <th>公告人(Author)</th>
                                    <th>主旨(Subject)</th>
                                    <th>狀態(Status)</th>
                                    <th>對象(Dept.)</th>
                                    @*<th>閱讀人數進度</th>*@
                                    <th style="font-size: 15px">閱讀人數(Read cnt)</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(raw,idx) in rawDataPage">
                                    @*<td width="10%"><span class="badge">5</span>{{raw.date}}</td>*@
                                    @*<td width="10%"><i class="star"></i>{{raw.date}}</td>*@
                                    <td width="12%"><div><span v-if="raw.isNewPost" class="newShining">New</span>{{raw.date}}</div></td>
                                    <td width="12%">{{raw.authorName}}</td>
                                    <td>{{raw.subject}}</td>
                                    <td width="8%">
                                        <span v-if="raw.status == '未讀(unread)'" class="badge bg-danger" style="font-size: 90%">{{raw.status}}</span>
                                        <span v-if="raw.status == '已讀(read)'" class="badge bg-success" style="font-size: 90%">{{raw.status}}</span>
                                        <span v-if="raw.status == ''"></span>
                                    </td>
                                    @*<td width="15%">
                                            <div class="progress">
                                                <div class="progress-bar progress-bar-striped bg-success progress-bar-animated" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </td>*@
                                    <td width="15%">
                                        @*<div name="tgSection" v-for="(section, idx) in raw.targetSections" style="font-size: 12px;">{{section}}</div>*@
                                        <div name="tgSection" style="font-size: 12px;">{{raw.targetSectionStr}}</div>
                                    </td>
                                    <td width="10%">{{raw.readCount}}</td>
                                    <td width="12%">
                                        <a class="btn btn-sm" data-toggle="modal" style="font-size:15px" :data-target="detailModalShow" @@click="detailClk(raw.serialNo, raw.isNeedUpdate, idx)">
                                            <i class="far fa-eye" href="#" title="detail"></i>
                                        </a>
                                        <a class="btn btn-sm" v-if="permision.accountPermission & 32">
                                            <i class="fas fa-download" href="#" title="下載閱讀名單" @@click="readFileDownload(raw.serialNo)"></i>
                                        </a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- /.card-body -->
                    <div class="card-footer" style="display: flex;" v-if="rawData.length > 0">
                        <div style="width: 12%;">
                            <label class="col-form-label">總筆數：{{rawData.length}}</label>
                        </div>
                        <div style="width: 15%; ">
                            <label class="col-form-label">每頁</label>
                            <select v-model="currentSize" @@change="sizeChange">
                                <option v-for="size in pageSizeOption" :value="size">{{size}}</option>
                            </select>
                            <label class="col-form-label">筆</label>
                        </div>
                        <div style="width: 73%;">
                            <template>
                                <div class="mt-10" style="float: right;">
                                    <b-pagination v-model="currentPage" pills :total-rows="rawData.length" :per-page="currentSize" @@page-click="pageChange"></b-pagination>
                                </div>
                            </template>
                        </div>
                    </div>
                    <!-- /.card-body -->
                </div>

                <!-- Modal Create -->
                <div class="modal fade" id="createModal" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="createModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="card-title">建立公告</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close" @@click="closeCreateModal"><span aria-hidden="true">✕</span></button>
                            </div>
                            <div class="modal-body">
                                <form id="createForm">
                                    <div class="col-lg-12 d-flex">
                                        <div class="col-lg-2">
                                            <label class="form-label" style="font-size: 20px;">主旨</label>
                                        </div>
                                        <div class="col-lg-10">
                                            <input style="border: 1px solid rgba(86,61,124,0.7); width: 100%;" v-model="createModel.subject" />
                                        </div>
                                    </div>
                                    <div class="col-lg-12 d-flex">
                                        <div class="col-lg-2">
                                            <label class="form-label" style="font-size: 20px;">內容</label>
                                        </div>
                                        <div class="col-lg-10">
                                            <textarea style="border: 1px solid rgba(86,61,124,0.7); width: 100%;" rows="4" v-model="createModel.content"></textarea>
                                        </div>
                                    </div>
                                    <div class="col-lg-12 d-flex">
                                        <div class="col-lg-2">
                                            <label class="form-label" style="font-size: 20px;">對象</label>
                                        </div>
                                        <div class="col-lg-10">
                                            <select id="dropTarget" v-model="selectTarget" multiple="multiple">
                                                <option v-for="section in sectionOptions" v-bind:value="section.id">{{section.value}}</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-lg-12 d-flex">
                                        <div class="col-lg-2">
                                            <label class="form-label" style="font-size: 17px;">是否包含IDL?</label>
                                        </div>
                                        <div class="col-lg-4">
                                            <input class="form-control-sm" type="checkbox" v-model="createModel.isIncludeIDL" @@click="onIncludeChange" />
                                        </div>
                                    </div>
                                    <div class="col-lg-12 d-flex" style="margin-top:5px">
                                        <div class="col-lg-2">
                                            <label class="form-label" style="font-size: 20px;" v-model="createModel.uploadFile">檔案</label>
                                            <div>
                                                <span class="unit">(允許 excel,word,ppt,圖片)</span>
                                            </div>
                                        </div>
                                        <div class="col-lg-10">
                                            <input class="custom-file" type="file" placeholder="選取公告檔案" v-on:change="onFileChange" />
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <input class="btn btn-sm btn-outline-primary" type="button" value="建立" @@click="createClk" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Detail -->
                <div class="modal fade" id="detailModal" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="detailModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                @*<h5 class="modal-title" id="gridModalLabel"></h5>*@
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-3" name="title">主旨(Subject)</div>
                                    <div class="col-md-9">{{detailModel.subject}}</div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3" name="title">公告人(Author)</div>
                                    <div class="col-md-3">{{detailModel.authorName}}</div>
                                    <div class="col-md-3" name="title">日期(Date)</div>
                                    <div class="col-md-3">{{detailModel.date}}</div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3" name="title">內容(Content)</div>
                                    <div class="col-md-9" style="white-space: pre-line;">{{detailModel.content}}</div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3" name="title">附件(Attachment)</div>
                                    <div class="col-md-9"><a href="#" target="_blank" @@click="fileDownloadClk(detailModel.serialNo, detailModel.isNeedUpdate, detailModel.rawIndex)">{{detailModel.fileName}}</a></div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <div class="col-md-12" name="remark">※ 若無點選下載附件, 系統將視作未讀 ※</div>
                                <div class="col-md-12" name="remark">※ If no clicked attachment download, system marked unread ※</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>


@section scripts
{
    <script src="~/plugins/select2/js/select2.full.min.js"></script>
    <script src="~/plugins/jsgrid/jsgrid.min.js"></script>
    <script src="~/plugins/jszip/jszip.min.js"></script>
    <script src="~/lib/bootstrap-vue/bootstrap-vue.min.js"></script>
    <script type="text/javascript">

        const _table = null;

        const vue = new Vue({
            el: '#app',
            data: {
                rawData: [],
                rawDataPage: [],
                permision: @Html.Raw(Json.Serialize(ViewBag.UserPermission)),
                currentPage: 1,
                pageSizeOption: [10, 50, 100],
                currentSize: 10,
                ttlPage: 0,
                readStatus: '',
                statusOptions: [
                    {
                        text: '',
                        value: 0
                    },
                    {
                        text: '未讀',
                        value: 1
                    },
                    {
                        text: '已讀',
                        value: 2
                    }
                ],
                sectionOptions: @Html.Raw(Json.Serialize(ViewBag.SectionOption)),
                selectTarget: '',
                selectStation: '',
                createModel: {
                    subject: '',
                    content: '',
                    target: '',
                    uploadFile: '',
                    isIncludeIDL: false
                },
                detailModel: {},
                detailModalShow: '#detailModal'
            },
            methods: {
                onSearchClk() {

                    globalFuc.LoadingPic();

                    $.ajax({
                        url: "./Bulletin/Search?dateRange=" + $("input[name='datepicker']").val() + '&readStatus=' + vue.readStatus,
                        type: "GET",
                        dataType: 'json',
                        success: function (result) {
                            if (result.isSuccess) {
                                vue.rawData = result.data;
                                vue.rawDataPage = result.data.slice(0, vue.currentSize);
                                vue.ttlPage = Math.ceil(result.data.length / vue.currentSize);
                            }
                            else {
                                alert(result.msg);
                            }
                            $.unblockUI();
                        }
                    });
                },
                onFileChange(e) {
                    if (this.verifyFile(e.target.files[0])) {
                        vue.createModel.uploadFile = e.target.files[0]
                    }
                },
                onIncludeChange(e) {
                    vue.createModel.isIncludeIDL = e.currentTarget.checked;
                },
                verifyFile(e) {
                    var validExtensions = ['xls', 'xlsx', 'pptx', 'pdf', 'docx', 'jpg', 'png'];
                    let fileEx = e.name.replace(/^.*\./, '');

                    if ($.inArray(fileEx.toLowerCase(), validExtensions) == -1) {
                        alert("無效檔案類型, 請確認檔案類型 .xls, .xlsx, .pptx .pdf .docx .jpg .png");
                        return false;
                    }
                    /* 暫訂上限 30MB */
                    else if (e.size > 31457280) {
                        alert("檔案過大");
                        return false;
                    }

                    return true;
                },
                sizeChange() {
                    vue.currentPage = 1;
                    vue.rawDataPage = vue.rawData.slice(0, vue.currentSize);
                },
                pageChange(even, pageNo) {
                    vue.currentPage = pageNo;
                    vue.rawDataPage = vue.rawData.slice(((vue.currentPage - 1) * vue.currentSize), vue.currentPage * vue.currentSize);
                },
                createClk() {

                    if (vue.createModel.subject == '' || vue.createModel.content == '' || $("#dropTarget").val() == '') {
                        alert('欄位皆必填');
                        return false;
                    }

                    if (vue.createModel.uploadFile == '') {
                        alert('請選取公告檔案');
                        return false;
                    }

                    let formData = new FormData();
                    formData.append('subject', vue.createModel.subject);
                    formData.append('content', vue.createModel.content);
                    formData.append('target', $("#dropTarget").val());
                    formData.append('uploadFile', vue.createModel.uploadFile);
                    formData.append('isIncludeIDL', vue.createModel.isIncludeIDL);

                    globalFuc.LoadingPic();

                    $.ajax({
                        url: "./Bulletin/Create",
                        type: "POST",
                        dataType: 'json',
                        processData: false,
                        contentType: false,
                        data: formData,
                        success: function (result) {
                            if (result.isSuccess) {
                                alert("公告成功");
                                location.reload();
                            }
                            else {
                                alert(result.msg);
                            }
                            $.unblockUI();
                        }
                    });
                },
                detailClk(bulletinSn, needUpd, idx) {

                    $.ajax({
                        url: "./Bulletin/Detail?bulletinSn=" + bulletinSn,
                        type: "GET",
                        dataType: 'json',
                        success: function (result) {
                            if (result.isSuccess) {
                                vue.detailModel = result.data;
                                vue.detailModel.isNeedUpdate = needUpd;
                                vue.detailModel['rawIndex'] = idx;
                                vue.detailModalShow = '#detailModal';
                            }
                            else {
                                vue.detailModel = {};
                                vue.detailModalShow = '';
                                alert(result.msg);
                            }
                        }
                    });
                },
                fileDownloadClk(bulletinSn, needUpd, rawIndex) {

                    if (needUpd) {
                        $.ajax({
                            url: "./Bulletin/UpdateDetail?bulletinSn=" + bulletinSn,
                            type: "PUT",
                            dataType: 'json',
                            success: function (result) {
                                if (result.isSuccess) {

                                    vue.rawData[(vue.currentPage - 1) * vue.currentSize + rawIndex].status = '已讀(read)';
                                    vue.rawData[(vue.currentPage - 1) * vue.currentSize + rawIndex].readCount += 1;

                                }
                                else {
                                    alert(result.msg);
                                }
                            }
                        });
                    }
                    window.location = "./Bulletin/DownloadFile?bulletinSn=" + bulletinSn;
                },
                readFileDownload(bulletinSn) {
                    window.location = "./Bulletin/DownloadReadInfoFile?bulletinSn=" + bulletinSn;
                },
                closeCreateModal() {
                    vue.createModel.subject = '';
                    vue.createModel.content = '';
                    vue.createModel.target = '';
                    $('option', $('#dropTarget')).each(function (element) {
                        $(this).removeAttr('selected').prop('selected', false);
                    });
                    $("#dropTarget").multiselect('refresh');
                    vue.createModel.uploadFile = '';
                }
            },
            mounted: function () {

                $("#dropTarget").multiselect();

                this.rawData = @Html.Raw(Json.Serialize(Model));
                this.rawDataPage = this.rawData.slice(0, 10);
                this.ttlPage = Math.ceil(this.rawData.length / 10);

                $('input[name="datepicker"]').daterangepicker({
                    timePicker: false,
                    startDate: moment().startOf('month').add(-1, 'month'),
                    endDate: moment(),
                    locale: {
                        format: 'yyyy/MM/DD'
                    }
                });
            },
            computed: {
            }
        });

    </script>
}
